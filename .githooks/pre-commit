#!/bin/bash

echo "Running Kainos pre-commit checks..."

if ! command -v pre-commit &> /dev/null; then
    echo "pre-commit not found, running basic checks..."

    if ! command -v go &> /dev/null; then
        echo "Error: go command not found"
        exit 1
    fi

    STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

    if [[ -z "$STAGED_GO_FILES" ]]; then
        echo "No staged Go files to format"
        exit 0
    fi

    echo "Found staged Go files:"
    echo "$STAGED_GO_FILES"

    echo "Running go fmt..."
    for file in $STAGED_GO_FILES; do
        if [[ -f "$file" ]]; then
            go fmt "./$(dirname "$file")"
            echo "Formatted: $file"
        fi
    done

    echo "Running go vet..."
    if [[ "$STAGED_GO_FILES" == *"core/"* ]]; then
        cd core && go vet ./... && cd ..
    fi
    if [[ "$STAGED_GO_FILES" == *"email/"* ]]; then
        cd email && go vet ./... && cd ..
    fi

    for file in $STAGED_GO_FILES; do
        if [[ -f "$file" ]]; then
            git add "$file"
        fi
    done

    echo "Basic pre-commit checks completed"
else
    echo "Running pre-commit hooks..."
    pre-commit run --hook-stage pre-commit

    if [ $? -ne 0 ]; then
        echo "Pre-commit hooks failed"
        echo "Run 'pre-commit run --all-files' to fix issues"
        exit 1
    fi

    echo "All pre-commit hooks passed"
fi

echo "Pre-commit checks completed successfully"
